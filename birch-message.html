<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../dialog-el/dialog-el.html">
<link rel="import" href="../fs-styles/fs-styles-full.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <birch-message></birch-message>

Example:

    <birch-message>
      <h2>Hello birch-message</h2>
    </birch-message>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-message">
    <style include='fs-styles'></style>
    <style>
      #innerDialog {
        height: 540px;
        width: 450px;
      }
      #to-section {
        margin: 27px 0 20px;
      }
      #to-section p {
        width: 70px;
        display: inline-block;
      }
      #about-section {
        border-top: 1px solid #cccccc;
        border-bottom: 1px solid #cccccc;
        padding-top: 12px;
        padding-bottom: 20px;
      }
      #subject-section {
        border-bottom: 1px solid #cccccc;
        padding: 14px 0;
      }
      #message-section {
        padding: 14px 0;
      }
      #message-section #textarea {
        min-height: 130px;
        max-height: 200px;
      }
      #message-section .char-count {
        text-align: right;
      }
      #footer-buttons {
        position: absolute;
        bottom: 16px;
      }
    </style>

  <template>
    <iron-ajax id="sendReq"
      url="[[ajaxBase]]/fst/mailbox/u2ms/api/v1/threads"
      headers='[[authHeaders]]'
      method='POST'
      content-type="application/json"
      handle-as="json"
      body='[[_body]]'
      on-response="_handleResponse"></iron-ajax>
    <dialog-el id="dialogBox" modal>
      <div id="innerDialog">
        <h4>New Message</h4>
        <div id="to-section">
          <p>To</p>
          <span>[[contactName]]</span>
        </div>
        <div id="about-section">
          <p>About</p>
          <div>[[_documentTitle]]</div>
          <div>[[_pageURL]]</div>
        </div>
        <div id="subject-section">
          <label for="text">Subject</label>
          <input id="text" type="text" maxlength="255" on-keyup="_checkContentFilled" placeholder="Write a Subject"/>
        </div>
        <div id="message-section">
          <label for="textarea">Message</label>
          <textarea id="textarea" rows="1" cols="48" maxlength="10000" placeholder="Write a Message" on-keyup="_countChar"></textarea>
          <p class="char-count">[[_charactersLeft]]</p>
        </div>
        <div id="footer-buttons">
          <button id="sendButton" type="button" class$="fs-button fs-button--recommended[[_buttonLoading(_requestPending)]]" on-tap="_postMessage" disabled>Send</button>
          <button type="button" class="fs-button fs-button--minor" on-tap="close">Cancel</button>
        </div>
      </div>
    </dialog-el>

  </template>

  <script>
    Polymer({
      is: 'birch-message',

        behaviors: [
          OakAJAXBehavior,
          OakI18nBehavior,
          WCI18nBehavior
        ],

      properties: {
        /**
         * `fancy` indicates that the element should don a monocle and tophat,
         * while checking its pocket watch.
         */
        contactName: {
          type: String,
          value: "Patron"
        },
        toUserIds: {
          type: Array
        },
        _body: {
          type: Object
        },
        _charactersLeft: {
          type: Number,
          value: 10000
        },
        _documentTitle: {
          type: String,
          value: document.title
        },
        _pageURL: {
          type: String,
          value: location.href
        },
        _requestPending: {
          type: Boolean,
          value: false
        }
      },

      ready: function() {
        console.log('ready!')
      },

      show: function() {
        this.$.dialogBox.show();
      },

      close: function() {
        this.$.dialogBox.close();
      },
      _buttonLoading: function(requestPending){
        return requestPending ? ' fs-button--loading' : '';
      },
      _checkContentFilled: function(){
        this.debounce('content-filled-debouncer', function() {
          this.$.sendButton.disabled = !(this.$.textarea.value.length > 0 && this.$.text.value.length > 0);
        }, 300);
      },
      _countChar: function(e) {
        this.debounce('count-debouncer', function(){
          this._charactersLeft = 10000 - e.target.value.length;
        }, 300);
        this._checkContentFilled(); 
      },
      _createBody: function() {
        this._body = {
          about: this._documentTitle,
          aboutUrl: this._pageURL,
          body: this.$.textarea.value,
          subject: this.$.text.value,
          toUserIds: this.toUserIds
        }
      },
      _handleResponse: function(e) {
        debugger;
      },
      _postMessage: function() {
        this._requestPending = true;
        this._createBody()
        this.$.sendReq.generateRequest();
      }

    });
  </script>
</dom-module>
