<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-dialog/cedar-dialog.html">
<link rel="import" href="../fs-button/fs-button.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <birch-message></birch-message>

Example:

    <birch-message>
      <h2>Hello birch-message</h2>
    </birch-message>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-message">
    <style include='fs-styles'></style>
    <style>
      #to-section {
        margin: 27px 0 20px;
      }
      #to-section p {
        width: 70px;
        display: inline-block;
      }
      #about-section {
        border-top: 1px solid #cccccc;
        border-bottom: 1px solid #cccccc;
        padding-top: 12px;
        padding-bottom: 20px;
      }
      #subject-section {
        border-bottom: 1px solid #cccccc;
        padding: 14px 0;
      }
      #message-section {
        padding: 14px 0;
      }
      #message-section #textarea {
        min-height: 130px;
        max-height: 200px;
      }
      #message-section .char-count {
        text-align: right;
      }
    </style>

  <template>
    <iron-ajax id="sendReq"
      url="[[ajaxBase]]/fst/mailbox/u2ms/api/v1/threads"
      headers="[[authHeaders]]"
      method="POST"
      content-type="application/json"
      handle-as="json"
      body="[[_body]]"
      on-response="_handleResponse"></iron-ajax>
    <cedar-dialog id="dialogBox" modal>
        <h4 header>New Message</h4>
        <div id="innerDialog" content>
          <div id="to-section">
            <p>To</p>
            <span>[[contactName]]</span>
          </div>
          <div id="about-section">
            <p>About</p>
            <div>[[_documentTitle]]</div>
            <div>[[_pageURL]]</div>
          </div>
          <div id="subject-section">
            <label for="text">Subject</label>
            <input id="text" type="text" maxlength="255" on-keyup="_checkContentFilled" placeholder="Write a Subject"/>
          </div>
          <div id="message-section">
            <label for="textarea">Message</label>
            <textarea id="textarea" rows="1" cols="48" maxlength="10000" placeholder="Write a Message" on-keyup="_countChar"></textarea>
            <p class="char-count">[[_charactersLeft]]</p>
          </div>
        </div>
        <div id="footer-buttons" footer>
          <button is='fs-button' id="sendButton" type="button" option="recommended" on-tap="_postMessage" disabled>Send</button>
          <button is='fs-button' type="button" option="minor" on-tap="close">Cancel</button>
        </div>
      </div>
    </cedar-dialog>

  </template>

  <script>
    Polymer({
      is: 'birch-message',

        behaviors: [
          OakAJAXBehavior,
          OakI18nBehavior,
          WCI18nBehavior
        ],

      properties: {
        /**
         * `fancy` indicates that the element should don a monocle and tophat,
         * while checking its pocket watch.
         */
        contactName: {
          type: String,
          value: "Patron"
        },
        toUserIds: {
          type: Array
        },
        _body: {
          type: Object
        },
        _charactersLeft: {
          type: Number,
          value: 10000
        },
        _documentTitle: {
          type: String,
          value: document.title
        },
        _pageURL: {
          type: String,
          value: location.href
        }
      },

      ready: function() {
        console.log('ready!')
      },

      show: function() {
        this.$.dialogBox.open();
      },

      close: function() {
        this.$.dialogBox.close();
      },
      _checkContentFilled: function(){
        this.debounce('content-filled-debouncer', function() {
          this.$.sendButton.disabled = !(this.$.textarea.value.length > 0 && this.$.text.value.length > 0);
        }, 300);
      },
      _countChar: function(e) {
        this.debounce('count-debouncer', function(){
          this._charactersLeft = 10000 - e.target.value.length;
        }, 300);
        this._checkContentFilled(); 
      },
      _createBody: function() {
        this._body = {
          about: this._documentTitle,
          aboutUrl: this._pageURL,
          body: this.$.textarea.value,
          subject: this.$.text.value,
          toUserIds: this.toUserIds
        }
      },
      _handleResponse: function(e) {
        debugger;
      },
      _postMessage: function() {
        this.$.sendButton.loading = true;
        this.$.sendButton.disabled = true;
        this._createBody()
        this.$.sendReq.generateRequest();
      }

    });
  </script>
</dom-module>
