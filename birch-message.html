<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-dialog/cedar-dialog.html">
<link rel="import" href="../fs-button/fs-button.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../cedar-alert/cedar-alert.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <birch-message></birch-message>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-message">
    <style include='fs-styles'></style>
    <link rel="import" type="css" href="birch-message.css">
  <template>
    <iron-ajax id="sendReq"
      url="[[ajaxBase]]/fst/mailbox/u2ms/api/v1/threads"
      headers="[[authHeaders]]"
      method="POST"
      content-type="application/json"
      handle-as="json"
      body="[[_body]]"
      on-response="_handleResponse"
      on-error="_handleError"></iron-ajax>
    <cedar-dialog id="dialogBox" modal>
        <h4 header>[[i18n('new_message')]]</h4>
        <div id="innerDialog" content>
          <div id="to-section">
            <p>[[i18n('to')]]</p>
            <span>[[contactName]]</span>
          </div>
          <div id="about-section">
            <p>About</p>
            <div class="about-data">
              <div hidden="[[_hideAboutDetails]]">[[_documentTitle]]</div>
              <div hidden="[[_hideAboutDetails]]">[[_pageURL]]</div>
            </div>
            <a class="remove-undo-about" href="javascript:void(0)" on-tap="_handleRemove" hidden="[[_hideAboutDetails]]">[[i18n('remove')]]</a>
            <a class="remove-undo-about" href="javascript:void(0)" on-tap="_handleUndo" hidden="[[!_hideAboutDetails]]">[[i18n('undo')]]</a>
          </div>
          <div id="subject-section">
            <label for="text">[[i18n('subject')]]</label>
            <span>[[i18n('write_subject')]]</span>
            <input id="text" type="text" maxlength="255" on-keyup="_checkContentFilled" placeholder$="{{i18n('write_subject')}}"/>
          </div>
          <div id="message-section">
            <label for="textarea">[[i18n('message')]]</label>
            <span id="writeMessage">[[i18n('write_message')]]</span>
            <textarea id="textarea" rows="1" cols="48" maxlength="10000" placeholder$="{{i18n('write_message')}}" on-keyup="_countChar"></textarea>
            <p class="char-count">[[_charactersLeft]]</p>
          </div>
          <div id="error-section" hidden="[[!error]]">
            <span>[[i18n('error')]]</span>
            <cedar-alert alert-type="error">[[i18n('error')]]</cedar-alert>
          </div>
        </div>
        <div id="footer-buttons" footer>
          <button is='fs-button' id="sendButton" type="button" option="recommended" on-tap="_postMessage" disabled>[[i18n('send')]]</button>
          <button is='fs-button' type="button" option="minor" on-tap="close">[[i18n('cancel')]]</button>
        </div>
      </div>
    </cedar-dialog>

  </template>

  <script>
    Polymer({
      is: 'birch-message',

        behaviors: [
          OakAJAXBehavior,
          OakI18nBehavior,
          WCI18n()
        ],

      properties: {
        /**
         * Goes in the "To" row. Identifies the contact name of the person you the user is sending a message to.
        **/
        contactName: {
          type: String,
          value: "Patron"
        },
        /**
         * Will be set to true if there is an error in the call for the data.
        **/
        error: {
          type: Boolean,
          value: false
        },
        /**
         * An array of the user IDs you want to send the message to. Must be an array or network call won't work.
        **/
        toUserIds: {
          type: Array
        },
        _body: {
          type: Object
        },
        _charactersLeft: {
          type: Number,
          value: 10000
        },
        _documentTitle: {
          type: String,
          value: document.title
        },
        _hideAboutDetails: {
          type: Boolean,
          value: false
        },
        _pageURL: {
          type: String,
          value: location.href
        }
      },
      /**
        Method for opening the message dialog.
      **/
      open: function() {
        this.$.dialogBox.open();
      },
      /**
        Method for closing the message dialog.
      **/
      close: function() {
        this.$.dialogBox.close();
      },
      _checkContentFilled: function(){
        this.debounce('content-filled-debouncer', function() {
          this.error = false;
          this.$.sendButton.disabled = !(this.$.textarea.value.length > 0 && this.$.text.value.length > 0);
        }, 300);
      },
      _clearText: function() {
        this.$.text.value = "";
        this.$.textarea.value = "";
      },
      _countChar: function(e) {
        this.debounce('count-debouncer', function(){
          this._charactersLeft = 10000 - this.$.textarea.value.length;
        }, 300);
        this._checkContentFilled();
      },
      _createBody: function() {
        this._body = {
          body: this.$.textarea.value,
          subject: this.$.text.value,
          toUserIds: this.toUserIds
        }
        if (!this._hideAboutDetails) {
          this._body.about = this._documentTitle,
          this._body.aboutUrl = this._pageURL
        }
      },
      _handleError: function(e) {
        console.log('error')
        this.error = true;
        this.$.sendButton.loading = false;
        this.$.sendButton.disabled = false;
        this.fire('birch-message-error', e.detail);
      },
      _handleUndo: function(e) {
        this._hideAboutDetails = false;
      },
      _handleRemove: function(e) {
        this._hideAboutDetails = true;
      },
      _handleResponse: function(e) {
        console.log('success')
        if(window.s && s.tl) {
          s.tl(true, "o", "Mailbox: Thread Created");
          s.tl(true, "o", "Mailbox: Message Sent");
        }
        if (e.detail.status < 400) this.$.dialogBox.close();
        this.$.sendButton.loading = false;
        this._clearText();
        this.fire('birch-message-sent', e.detail);
      },
      _postMessage: function() {
        this.$.sendButton.loading = true;
        this.$.sendButton.disabled = true;
        this._createBody();
        this.$.sendReq.generateRequest();
      }

    });
  </script>
</dom-module>
